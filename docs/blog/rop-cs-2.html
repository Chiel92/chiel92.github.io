<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="Asciidoctor 2.0.15"><title>Railroad Oriented Programming in C#: Part 2</title><link rel="stylesheet" href="/blog/unit-cs.6720997f.css"><base target="_parent"><script type="text/javascript" src="https://livejs.com/live.js"></script></head><body class="article"> <div id="header"> <h1>Railroad Oriented Programming in C#: Part 2</h1> </div> <div id="content"> <div class="sect1"> <h2 id="_a_result_type_supporting_the_failure_path">A Result type supporting the failure path</h2> <div class="sectionbody"> <div class="paragraph"> <p>While C# does not directory support Discriminated Unions, it does support subclassing. Since a class can have multiple subclasses, and any object is always just one of them, we can use this phenomenon to implement the notion of having two returntypes, one for success result, and one for the failure result.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-cs" data-lang="cs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Result</span> {
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Success</span> : <span class="hljs-title">Result</span> { }
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Failure</span> : <span class="hljs-title">Result</span> { }
  <span class="hljs-comment">// Private constructor so we are certain that Success and Failure are the only subclasses</span>
  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Result</span> (<span class="hljs-params"></span>)</span> { }
}</code></pre> </div> </div> <div class="paragraph"> <p>However, this class does not allow us to associate any return data with either the success or the failure result. We can fix that.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-cs" data-lang="cs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Result</span>&lt;<span class="hljs-title">TSuccess</span>, <span class="hljs-title">TFailure</span>&gt; {
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Success</span> : <span class="hljs-title">Result</span>&lt;<span class="hljs-title">TSuccess</span>, <span class="hljs-title">TFailure</span>&gt; {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> TSuccess SuccessValue;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Success</span>(<span class="hljs-params">TSuccess result</span>)</span>{
      SuccessValue = result;
    }
  }
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Failure</span> : <span class="hljs-title">Result</span>&lt;<span class="hljs-title">TSuccess</span>, <span class="hljs-title">TFailure</span>&gt; {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> TFailure FailureValue;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Failure</span>(<span class="hljs-params">TFailure error</span>)</span>{
      FailureValue = error;
    }
  }
  <span class="hljs-comment">// Private constructor so we are certain that Success and Failure are the only subclasses</span>
  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Result</span> (<span class="hljs-params"></span>)</span> { }
}</code></pre> </div> </div> <div class="paragraph"> <p>With this in our toolkit we can now implement our <code>GetEmailAddress</code> function from earlier with an explicit failure path.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-cs" data-lang="cs"><span class="hljs-function">Result&lt;User, <span class="hljs-built_in">string</span>&gt; <span class="hljs-title">GetUser</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> username</span>)</span> {
  <span class="hljs-keyword">var</span> user = Datastore.FindUser(username);
  <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result&lt;User, <span class="hljs-built_in">string</span>&gt;.Failure(<span class="hljs-string">&quot;User has no email&quot;</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result&lt;User, <span class="hljs-built_in">string</span>&gt;.Success(user);
}</code></pre> </div> </div> <div class="paragraph"> <p>Usage of this function would look something like</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-cs" data-lang="cs"><span class="hljs-keyword">var</span> result = GetUser(username);
<span class="hljs-keyword">if</span> (result <span class="hljs-keyword">is</span> Result&lt;User,<span class="hljs-built_in">string</span>&gt;.Success) {
  <span class="hljs-keyword">var</span> user = ((Result&lt;User,<span class="hljs-built_in">string</span>&gt;.Success)result).ResultValue;
  <span class="hljs-comment">// Do what you wanna do</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-keyword">var</span> error = ((Result&lt;User,<span class="hljs-built_in">string</span>&gt;.Failure)result).ErrorValue;
  <span class="hljs-comment">// Handle the failure appropriately</span>
}</code></pre> </div> </div> <div class="paragraph"> <p>As you can see we&#8217;ve achieved an explicit failure path. When we call <code>GetUser</code> we obtain a result object and this encourages us to consider both the success and the failure case. But the code leaves much to be desired. Even more so when we need to call more than one function.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-cs" data-lang="cs"><span class="hljs-function">Result&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; <span class="hljs-title">GetEmailAddress</span>(<span class="hljs-params">User user</span>)</span>;

<span class="hljs-comment">// ...</span>

<span class="hljs-keyword">var</span> result = GetUser(username);
<span class="hljs-keyword">if</span> (result <span class="hljs-keyword">is</span> Result&lt;User, <span class="hljs-built_in">string</span>&gt;.Success) {
  <span class="hljs-keyword">var</span> user = ((Result&lt;User, <span class="hljs-built_in">string</span>&gt;.Success)result).ResultValue;
  <span class="hljs-keyword">var</span> result2 = GetEmailAddress(user);
  <span class="hljs-keyword">if</span> (result2 <span class="hljs-keyword">is</span> Result&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;.Success) {
    <span class="hljs-keyword">var</span> email = ((Result&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;.Success)result2).ResultValue;
    <span class="hljs-comment">// And so on...</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">var</span> error2 = ((Result&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;.Failure)result2).ErrorValue;
    <span class="hljs-comment">// Handle the failure appropriately</span>
  }
} <span class="hljs-keyword">else</span> {
  <span class="hljs-keyword">var</span> error = ((Result&lt;User, <span class="hljs-built_in">string</span>&gt;.Failure)result).ErrorValue;
  <span class="hljs-comment">// Handle the failure appropriately</span>
}</code></pre> </div> </div> <div class="paragraph"> <p>We would like to</p> </div> <div class="ulist"> <ul> <li> <p>not have to unwrap the result type by doing a type check + cast</p> </li> <li> <p>not have a new nesting level for each subsequent function we call</p> </li> <li> <p>not have to handle all failures individually</p> </li> <li> <p>not have to specify the whole type when creating a Result instance: <code>new Result&lt;User, string&gt;.Success()</code></p> </li> </ul> </div> <div class="sect2"> <h3 id="_a_fluent_result_type">A Fluent Result type</h3> <div class="paragraph"> <p>To resolve the complaints about our previous implementation, we&#8217;ll define an <code>OnSuccess</code> function and a <code>Handle</code> function. They will do the unwrapping for us and form a <a href="https://en.wikipedia.org/wiki/Fluent_interface">Fluent Interface</a> and thereby removing the nesting. Moreover, the OnSuccess function will "shortcircuit" the failure path, such that we only have to handle the failure path once.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-cs" data-lang="cs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Result</span>&lt;<span class="hljs-title">TS</span>, <span class="hljs-title">TF</span>&gt; {
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-title">Result</span>&lt;<span class="hljs-title">TNextR</span>, <span class="hljs-title">TF</span>&gt; <span class="hljs-title">OnSuccess</span>&lt;<span class="hljs-title">TNextR</span>&gt;(<span class="hljs-params">Func&lt;TS, Result&lt;TNextR, TF&gt;&gt; onSuccess</span>)</span>;
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> TReturn <span class="hljs-title">Handle</span>&lt;<span class="hljs-title">TReturn</span>&gt;(<span class="hljs-params">Func&lt;TS, TReturn&gt; onSuccess, Func&lt;TF, TReturn&gt; onFailure</span>)</span>;

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Success</span> : <span class="hljs-title">Result</span>&lt;<span class="hljs-title">TS</span>, <span class="hljs-title">TF</span>&gt; {
    <span class="hljs-keyword">public</span> TS SuccessValue { <span class="hljs-keyword">get</span>; }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Success</span>(<span class="hljs-params">TS result</span>)</span> =&gt; SuccessValue = result;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-title">Result</span>&lt;<span class="hljs-title">TNextR</span>, <span class="hljs-title">TF</span>&gt; <span class="hljs-title">OnSuccess</span>&lt;<span class="hljs-title">TNextR</span>&gt;(<span class="hljs-params">Func&lt;TS, Result&lt;TNextR, TF&gt;&gt; onSuccess</span>)</span>
        =&gt; onSuccess(SuccessValue);
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> TReturn <span class="hljs-title">Handle</span>&lt;<span class="hljs-title">TReturn</span>&gt;(<span class="hljs-params">Func&lt;TS, TReturn&gt; onSuccess, Func&lt;TF, TReturn&gt; onFailure</span>)</span>
        =&gt; onSuccess(SuccessValue);
  }

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Failure</span> : <span class="hljs-title">Result</span>&lt;<span class="hljs-title">TS</span>, <span class="hljs-title">TF</span>&gt; {
    <span class="hljs-keyword">public</span> TF FailureValue { <span class="hljs-keyword">get</span>; }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Failure</span>(<span class="hljs-params">TF error</span>)</span> =&gt; FailureValue = error;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-title">Result</span>&lt;<span class="hljs-title">TNextR</span>, <span class="hljs-title">TF</span>&gt; <span class="hljs-title">OnSuccess</span>&lt;<span class="hljs-title">TNextR</span>&gt;(<span class="hljs-params">Func&lt;TS, Result&lt;TNextR, TF&gt;&gt; onSuccess</span>)</span>
        =&gt; Result.Fail(FailureValue);
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> TReturn <span class="hljs-title">Handle</span>&lt;<span class="hljs-title">TReturn</span>&gt;(<span class="hljs-params">Func&lt;TS, TReturn&gt; onSuccess, Func&lt;TF, TReturn&gt; onFailure</span>)</span>
        =&gt; onFailure(FailureValue);
  }
  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Result</span>(<span class="hljs-params"></span>)</span> { }
}</code></pre> </div> </div> <div class="paragraph"> <p>Apart from the daunting function signatures, the actual function bodies are trivial. Yet they suddenly allow us to write very concise code. Compare the following with what we had in the previous section.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-cs" data-lang="cs">GetUser(username)
  .OnSuccess(GetEmailAddress);
  .Handle(
    emailAddress =&gt; ..., <span class="hljs-comment">// Do your thing</span>
    error =&gt; ... <span class="hljs-comment">// Handle the failure appropriately</span>
  );</code></pre> </div> </div> <div class="paragraph"> <p>This style of programming is sometimes referred to as <a href="https://fsharpforfunandprofit.com/rop/"><em>railway oriented programming</em></a>, a term first invented by Scott Wlaschin. Why that is the case is easily demonstrated with some diagrams. The Result type encapsulates two "paths" or "tracks", the success track and the failure track.</p> </div> <div class="imageblock kroki"> <div class="content"> <svg xmlns="http://www.w3.org/2000/svg" class="pikchr" width="149" height="51" viewbox="0 0 187.43 64.8"> <polygon points="106,17 95,21 95,12" style="fill:#add8e6"></polygon> <path d="M34,17L100,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <polygon points="106,47 95,51 95,43" style="fill:orange"></polygon> <path d="M34,47L100,47" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M17,47L52,47A15 15 0 0 0 67 32A15 15 0 0 0 52 17L17,17A15 15 0 0 0 2 32A15 15 0 0 0 17 47Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="34" y="32" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">Result</text> <path d="M121,32L170,32A15 15 0 0 0 185 17A15 15 0 0 0 170 2L121,2A15 15 0 0 0 106 17A15 15 0 0 0 121 32Z" style="fill:#add8e6;stroke-width:2.16;stroke:#000"></path> <text x="145" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">Success</text> <path d="M121,62L163,62A15 15 0 0 0 178 47A15 15 0 0 0 163 32L121,32A15 15 0 0 0 106 47A15 15 0 0 0 121 62Z" style="fill:orange;stroke-width:2.16;stroke:#000"></path> <text x="142" y="47" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">Failure</text> </svg> </div> </div> <div class="paragraph"> <p>And the <code>OnSuccess</code> and <code>Handle</code> methods form trackpieces.</p> </div> <div class="imageblock kroki"> <div class="content"> <svg xmlns="http://www.w3.org/2000/svg" class="pikchr" width="508" height="44" viewbox="0 0 636.653 55.44"> <path d="M133,17 L 140,17 Q 147,17 147,31 L 147,34 Q 147,48 156,48 L 165,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M133,17L165,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M291,17L307,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <polygon points="30,17 19,21 19,12" style="fill:#add8e6"></polygon> <path d="M2,17L25,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M30,32L133,32L133,2L30,2Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="82" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">OnSuccess</text> <path d="M180,32L276,32A15 15 0 0 0 291 17A15 15 0 0 0 276 2L180,2A15 15 0 0 0 165 17A15 15 0 0 0 180 32Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="228" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">SuccessValue</text> <path d="M2,48L307,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <polygon points="407,17 396,21 396,12" style="fill:#add8e6"></polygon> <path d="M379,17L402,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <polygon points="407,48 396,53 396,44" style="fill:orange"></polygon> <path d="M379,48L402,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M407,48L480,48L480,17L407,17Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="444" y="33" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">Handle</text> <path d="M480,33L508,33" style="fill:none;stroke-width:2.16;stroke:#000"></path> <path d="M524,48L586,48A15 15 0 0 0 601 33L601,33A15 15 0 0 0 586 18L524,18A15 15 0 0 0 508 33L508,33A15 15 0 0 0 524 48Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="555" y="33" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">EndValue</text> <polygon points="630,33 618,37 618,28" style="fill:#000"></polygon> <path d="M601,33L624,33" style="fill:none;stroke-width:2.16;stroke:#000"></path> </svg> </div> </div> <div class="paragraph"> <p>The railway of the example code would look like</p> </div> <div class="imageblock kroki"> <div class="content"> <svg xmlns="http://www.w3.org/2000/svg" class="pikchr" width="582" height="52" viewbox="0 0 728.064 66.24"> <path d="M111,17 L 118,17 Q 125,17 125,31 L 125,34 Q 125,48 134,48 L 142,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M204,48L219,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M111,17L139,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M191,17L207,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M392,17 L 399,17 Q 406,17 406,31 L 406,34 Q 406,48 415,48 L 424,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M392,17L424,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M485,17L501,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <polygon points="30,17 19,21 19,12" style="fill:#add8e6"></polygon> <path d="M2,17L25,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M30,32L111,32L111,2L30,2Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="70" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">GetUser</text> <path d="M157,64L188,64A15 15 0 0 0 204 48L204,48A15 15 0 0 0 188 33L157,33A15 15 0 0 0 142 48L142,48A15 15 0 0 0 157 64Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="173" y="48" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">string</text> <path d="M154,32L176,32A15 15 0 0 0 191 17A15 15 0 0 0 176 2L154,2A15 15 0 0 0 139 17A15 15 0 0 0 154 32Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="165" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">User</text> <polygon points="235,17 224,21 224,12" style="fill:#add8e6"></polygon> <path d="M207,17L230,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M235,32L392,32L392,2L235,2Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="314" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">GetEmailAddress</text> <path d="M439,32L470,32A15 15 0 0 0 485 17A15 15 0 0 0 470 2L439,2A15 15 0 0 0 424 17A15 15 0 0 0 439 32Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="454" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">string</text> <path d="M207,48L501,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <polygon points="530,17 518,21 518,12" style="fill:#add8e6"></polygon> <path d="M501,17L524,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <polygon points="530,48 518,53 518,44" style="fill:orange"></polygon> <path d="M501,48L524,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M530,48L602,48L602,17L530,17Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="566" y="33" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">Handle</text> <path d="M602,33L631,33" style="fill:none;stroke-width:2.16;stroke:#000"></path> <path d="M646,48L677,48A15 15 0 0 0 692 33L692,33A15 15 0 0 0 677 18L646,18A15 15 0 0 0 631 33L631,33A15 15 0 0 0 646 48Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="662" y="33" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">string</text> <polygon points="721,33 710,37 710,28" style="fill:#000"></polygon> <path d="M692,33L715,33" style="fill:none;stroke-width:2.16;stroke:#000"></path> </svg> </div> </div> </div> <div class="sect2"> <h3 id="_another_example">Another Example</h3> <div class="paragraph"> <p>Suppose now that we needed to write the following function.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-cs" data-lang="cs"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>Message to be printed on the screen<span class="hljs-doctag">&lt;/returns&gt;</span></span>
<span class="hljs-function"><span class="hljs-built_in">string</span> <span class="hljs-title">MailMessageToUser</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> username, <span class="hljs-built_in">string</span> msg</span>)</span>;</code></pre> </div> </div> <div class="paragraph"> <p>And suppose that we have the following functions at our disposal.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-cs" data-lang="cs"><span class="hljs-function">Result&lt;User, <span class="hljs-built_in">string</span>&gt; <span class="hljs-title">GetUser</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> username</span>)</span>;
<span class="hljs-function">Result&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; <span class="hljs-title">GetEmailAddress</span>(<span class="hljs-params">User user</span>)</span>;
<span class="hljs-function">Result&lt;EmailMessage, <span class="hljs-built_in">string</span>&gt; <span class="hljs-title">CreateEmailMessage</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> emailAddress, <span class="hljs-built_in">string</span> msg</span>)</span>;
<span class="hljs-function">Result&lt;Unit, <span class="hljs-built_in">string</span>&gt; <span class="hljs-title">SendEmail</span>(<span class="hljs-params">EmailMessage email</span>)</span>;</code></pre> </div> </div> <div class="paragraph"> <p>If you&#8217;re wondering what that <code>Unit</code> type is, it&#8217;s a replacement for <code>void</code>, since we can&#8217;t put <code>void</code> in there. For more information <a href="/?page=unit-cs">read my respective article</a>.</p> </div> <div class="paragraph"> <p>Then we could implement the function as follows.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-cs" data-lang="cs"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>Message to be printed on the screen<span class="hljs-doctag">&lt;/returns&gt;</span></span>
<span class="hljs-function"><span class="hljs-built_in">string</span> <span class="hljs-title">MailMessageToUser</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> username, <span class="hljs-built_in">string</span> msg</span>)</span> {
  <span class="hljs-keyword">return</span> GetUser(username)
    .OnSuccess(GetEmailAddress)
    .OnSuccess(email =&gt; CreateEmailMessage(email, msg))
    .OnSuccess(SendEmail)
    .Handle(
      _ =&gt; <span class="hljs-string">&quot;Email sent&quot;</span>,
      error =&gt; {
        Log(error);
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Email not sent&quot;</span>;
      }
    );
}</code></pre> </div> </div> <div class="paragraph"> <p>The railway of the example code would look like</p> </div> <div class="imageblock kroki"> <div class="content"> <svg xmlns="http://www.w3.org/2000/svg" class="pikchr" width="1086" height="44" viewbox="0 0 1358.32 55.44"> <path d="M111,17 L 118,17 Q 125,17 125,31 L 125,34 Q 125,48 134,48 L 142,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M111,17L142,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M194,17L210,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M395,17 L 402,17 Q 409,17 409,31 L 409,34 Q 409,48 418,48 L 427,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M395,17L427,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M488,17L504,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M724,17 L 731,17 Q 738,17 738,31 L 738,34 Q 738,48 747,48 L 755,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M724,17L755,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M889,17L905,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M1036,17 L 1043,17 Q 1050,17 1050,31 L 1050,34 Q 1050,48 1059,48 L 1068,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M1036,17L1068,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M1115,17L1131,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <polygon points="30,17 19,21 19,12" style="fill:#add8e6"></polygon> <path d="M2,17L25,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M30,32L111,32L111,2L30,2Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="70" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">GetUser</text> <path d="M157,32L179,32A15 15 0 0 0 194 17A15 15 0 0 0 179 2L157,2A15 15 0 0 0 142 17A15 15 0 0 0 157 32Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="168" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">User</text> <path d="M2,48L210,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <polygon points="238,17 227,21 227,12" style="fill:#add8e6"></polygon> <path d="M210,17L233,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M238,32L395,32L395,2L238,2Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="317" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">GetEmailAddress</text> <path d="M442,32L473,32A15 15 0 0 0 488 17A15 15 0 0 0 473 2L442,2A15 15 0 0 0 427 17A15 15 0 0 0 442 32Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="457" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">string</text> <path d="M210,48L504,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <polygon points="533,17 521,21 521,12" style="fill:#add8e6"></polygon> <path d="M504,17L527,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M533,32L724,32L724,2L533,2Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="628" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">CreateEmailMessage</text> <path d="M770,32L874,32A15 15 0 0 0 889 17A15 15 0 0 0 874 2L770,2A15 15 0 0 0 755 17A15 15 0 0 0 770 32Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="822" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">EmailMessage</text> <path d="M504,48L905,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <polygon points="934,17 922,21 922,12" style="fill:#add8e6"></polygon> <path d="M905,17L928,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M934,32L1036,32L1036,2L934,2Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="985" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">SendEmail</text> <path d="M1083,32L1100,32A15 15 0 0 0 1115 17A15 15 0 0 0 1100 2L1083,2A15 15 0 0 0 1068 17A15 15 0 0 0 1083 32Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="1091" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">Unit</text> <path d="M905,48L1131,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <polygon points="1160,17 1148,21 1148,12" style="fill:#add8e6"></polygon> <path d="M1131,17L1154,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <polygon points="1160,48 1148,53 1148,44" style="fill:orange"></polygon> <path d="M1131,48L1154,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M1160,48L1232,48L1232,17L1160,17Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="1196" y="33" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">Handle</text> <path d="M1232,33L1261,33" style="fill:none;stroke-width:2.16;stroke:#000"></path> <path d="M1276,48L1307,48A15 15 0 0 0 1323 33L1323,33A15 15 0 0 0 1307 18L1276,18A15 15 0 0 0 1261 33L1261,33A15 15 0 0 0 1276 48Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="1292" y="33" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">string</text> <polygon points="1351,33 1340,37 1340,28" style="fill:#000"></polygon> <path d="M1323,33L1346,33" style="fill:none;stroke-width:2.16;stroke:#000"></path> </svg> </div> </div> </div> <div class="sect2"> <h3 id="_the_onfailure_method">The OnFailure method</h3> <div class="paragraph"> <p>If we have a OnSuccess method, there is no reason why we couldn&#8217;t have an OnFailure method too. This would allow us to do operations on the failure track, such as modifying or logging the error, or recovering from the error and get back on the success track.</p> </div> <div class="imageblock kroki"> <div class="content"> <svg xmlns="http://www.w3.org/2000/svg" class="pikchr" width="137" height="40" viewbox="0 0 172.166 51.12"> <path d="M126,33 L 134,33 Q 141,33 141,19 L 141,16 Q 141,2 155,2 L 155,2 L 170,2" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M126,33L170,33" style="fill:none;stroke-width:2.16;stroke:orange"></path> <polygon points="30,33 19,38 19,29" style="fill:orange"></polygon> <path d="M2,33L25,33" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M30,48L126,48L126,18L30,18Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="78" y="33" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">OnFailure</text> <path d="M2,2L170,2" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> </svg> </div> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-cs" data-lang="cs"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>Message to be printed on the screen<span class="hljs-doctag">&lt;/returns&gt;</span></span>
<span class="hljs-function"><span class="hljs-built_in">string</span> <span class="hljs-title">MailMessageToUser</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> username, <span class="hljs-built_in">string</span> msg</span>)</span> {
  <span class="hljs-keyword">return</span> GetUser(username)
    .OnSuccess(GetEmailAddress)
    .OnSuccess(email =&gt; CreateEmailMessage(email, msg))
    .OnSuccess(SendEmail)
    .OnFailure&lt;<span class="hljs-built_in">string</span>&gt;(error =&gt; {
      LogError(error);
      <span class="hljs-keyword">return</span> Result.Fail(error); <span class="hljs-comment">// Only log the error and leave the Failure be</span>
    })
    .Handle(
      _ =&gt; <span class="hljs-string">&quot;Email sent&quot;</span>,
      _ =&gt; <span class="hljs-string">&quot;Email not sent&quot;</span>
    );
}</code></pre> </div> </div> <div class="imageblock kroki"> <div class="content"> <svg xmlns="http://www.w3.org/2000/svg" class="pikchr" width="1570" height="73" viewbox="0 0 1963.3 92.16"> <path d="M111,38 L 118,38 Q 125,38 125,52 L 125,55 Q 125,69 134,69 L 142,69" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M111,38L142,38" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M286,38L302,38" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M487,38 L 495,38 Q 502,38 502,52 L 502,55 Q 502,69 510,69 L 519,69" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M487,38L519,38" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M663,38L679,38" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M899,38 L 906,38 Q 913,38 913,52 L 913,55 Q 913,69 922,69 L 930,69" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M899,38L930,38" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M1074,38L1090,38" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M1221,38 L 1228,38 Q 1235,38 1235,52 L 1235,55 Q 1235,69 1244,69 L 1253,69" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M1221,38L1253,38" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M1397,38L1412,38" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M1545,69L1573,69" style="fill:none;stroke-width:2.16;stroke:orange"></path> <polygon points="30,38 19,42 19,33" style="fill:#add8e6"></polygon> <path d="M2,38L25,38" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M30,53L111,53L111,23L30,23Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="70" y="38" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">GetUser</text> <path d="M178,74L250,74A36 36 0 0 0 286 38A36 36 0 0 0 250 2L178,2A36 36 0 0 0 142 38A36 36 0 0 0 178 74Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <path d="M2,69L302,69" style="fill:none;stroke-width:2.16;stroke:orange"></path> <polygon points="331,38 319,42 319,33" style="fill:#add8e6"></polygon> <path d="M302,38L325,38" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M331,53L487,53L487,23L331,23Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="409" y="38" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">GetEmailAddress</text> <path d="M555,74L627,74A36 36 0 0 0 663 38A36 36 0 0 0 627 2L555,2A36 36 0 0 0 519 38A36 36 0 0 0 555 74Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <path d="M302,69L679,69" style="fill:none;stroke-width:2.16;stroke:orange"></path> <polygon points="708,38 696,42 696,33" style="fill:#add8e6"></polygon> <path d="M679,38L702,38" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M708,53L899,53L899,23L708,23Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="803" y="38" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">CreateEmailMessage</text> <path d="M966,74L1038,74A36 36 0 0 0 1074 38A36 36 0 0 0 1038 2L966,2A36 36 0 0 0 930 38A36 36 0 0 0 966 74Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <path d="M679,69L1090,69" style="fill:none;stroke-width:2.16;stroke:orange"></path> <polygon points="1119,38 1107,42 1107,33" style="fill:#add8e6"></polygon> <path d="M1090,38L1113,38" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M1119,53L1221,53L1221,23L1119,23Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="1170" y="38" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">SendEmail</text> <path d="M1289,74L1361,74A36 36 0 0 0 1397 38A36 36 0 0 0 1361 2L1289,2A36 36 0 0 0 1253 38A36 36 0 0 0 1289 74Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <path d="M1090,69L1412,69" style="fill:none;stroke-width:2.16;stroke:orange"></path> <polygon points="1441,69 1430,74 1430,65" style="fill:orange"></polygon> <path d="M1412,69L1435,69" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M1441,84L1545,84L1545,54L1441,54Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="1493" y="69" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">LogFailure</text> <path d="M1412,38L1573,38" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <polygon points="1602,38 1591,42 1591,33" style="fill:#add8e6"></polygon> <path d="M1573,38L1596,38" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <polygon points="1602,69 1591,74 1591,65" style="fill:orange"></polygon> <path d="M1573,69L1596,69" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M1602,69L1675,69L1675,38L1602,38Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="1638" y="54" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">Handle</text> <path d="M1675,54L1703,54" style="fill:none;stroke-width:2.16;stroke:#000"></path> <path d="M1739,90L1811,90A36 36 0 0 0 1847 54A36 36 0 0 0 1811 18L1739,18A36 36 0 0 0 1703 54A36 36 0 0 0 1739 90Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <polygon points="1876,54 1865,58 1865,49" style="fill:#000"></polygon> <path d="M1847,54L1870,54" style="fill:none;stroke-width:2.16;stroke:#000"></path> <path d="M1891,69L1946,69A15 15 0 0 0 1961 54L1961,54A15 15 0 0 0 1946 38L1891,38A15 15 0 0 0 1876 54L1876,54A15 15 0 0 0 1891 69Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="1918" y="54" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">message</text> </svg> </div> </div> <div class="paragraph"> <p>We still need to deal with the awkward construction of Result instances, and we&#8217;ll do that in the next part.</p> </div> </div> </div> </div> </div> <div id="footer"> <div id="footer-text"> Last updated 2021-08-02 13:17:03 +0200 </div> </div> </body></html>