<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="Asciidoctor 2.0.15"><title>Railroad Oriented Programming in C#: Part 2</title><link rel="stylesheet" href="/blog/unit-cs.6720997f.css"><base target="_parent"><script type="text/javascript" src="https://livejs.com/live.js"></script></head><body class="article"> <div id="header"> <h1>Railroad Oriented Programming in C#: Part 2</h1> </div> <div id="content"> <div class="sect1"> <h2 id="_a_result_type_supporting_the_failure_path">A Result type supporting the failure path</h2> <div class="sectionbody"> <div class="paragraph"> <p>While C# does not directory support Discriminated Unions, it does support subclassing. Since a class can have multiple subclasses, and any object is always just one of them, we can use this phenomenon to implement the notion of having two returntypes, one for success result, and one for the failure result.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-cs" data-lang="cs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Result</span> {
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Success</span> : <span class="hljs-title">Result</span> { }
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Failure</span> : <span class="hljs-title">Result</span> { }
  <span class="hljs-comment">// Private constructor so we are certain that Success and Failure are the only subclasses</span>
  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Result</span> (<span class="hljs-params"></span>)</span> { }
}</code></pre> </div> </div> <div class="paragraph"> <p>However, this class does not allow us to associate any return data with either the success or the failure result. We can fix that.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-cs" data-lang="cs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Result</span>&lt;<span class="hljs-title">TSuccess</span>, <span class="hljs-title">TFailure</span>&gt; {
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Success</span> : <span class="hljs-title">Result</span>&lt;<span class="hljs-title">TSuccess</span>, <span class="hljs-title">TFailure</span>&gt; {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> TSuccess SuccessValue;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Success</span>(<span class="hljs-params">TSuccess result</span>)</span>{
      SuccessValue = result;
    }
  }
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Failure</span> : <span class="hljs-title">Result</span>&lt;<span class="hljs-title">TSuccess</span>, <span class="hljs-title">TFailure</span>&gt; {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> TFailure FailureValue;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Failure</span>(<span class="hljs-params">TFailure error</span>)</span>{
      FailureValue = error;
    }
  }
  <span class="hljs-comment">// Private constructor so we are certain that Success and Failure are the only subclasses</span>
  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Result</span> (<span class="hljs-params"></span>)</span> { }
}</code></pre> </div> </div> <div class="paragraph"> <p>With this in our toolkit we can now implement our <code>GetEmailAddress</code> function from earlier with an explicit failure path.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-cs" data-lang="cs"><span class="hljs-function">Result&lt;User, <span class="hljs-built_in">string</span>&gt; <span class="hljs-title">GetUser</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> username</span>)</span> {
  <span class="hljs-keyword">var</span> user = Datastore.FindUser(username);
  <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result&lt;User, <span class="hljs-built_in">string</span>&gt;.Failure(<span class="hljs-string">&quot;User has no email&quot;</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result&lt;User, <span class="hljs-built_in">string</span>&gt;.Success(user);
}</code></pre> </div> </div> <div class="paragraph"> <p>Usage of this function would look something like</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-cs" data-lang="cs"><span class="hljs-keyword">var</span> result = GetUser(username);
<span class="hljs-keyword">if</span> (result <span class="hljs-keyword">is</span> Result&lt;User,<span class="hljs-built_in">string</span>&gt;.Success) {
  <span class="hljs-keyword">var</span> user = ((Result&lt;User,<span class="hljs-built_in">string</span>&gt;.Success)result).ResultValue;
  <span class="hljs-comment">// Do what you wanna do</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-keyword">var</span> error = ((Result&lt;User,<span class="hljs-built_in">string</span>&gt;.Failure)result).ErrorValue;
  <span class="hljs-comment">// Handle the failure appropriately</span>
}</code></pre> </div> </div> <div class="paragraph"> <p>As you can see we&#8217;ve achieved an explicit failure path. When we call <code>GetUser</code> we obtain a result object and this encourages us to consider both the success and the failure case. But the code leaves much to be desired. Even more so when we need to call more than one function.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-cs" data-lang="cs"><span class="hljs-function">Result&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; <span class="hljs-title">GetEmailAddress</span>(<span class="hljs-params">User user</span>)</span>;

<span class="hljs-comment">// ...</span>

<span class="hljs-keyword">var</span> result = GetUser(username);
<span class="hljs-keyword">if</span> (result <span class="hljs-keyword">is</span> Result&lt;User, <span class="hljs-built_in">string</span>&gt;.Success) {
  <span class="hljs-keyword">var</span> user = ((Result&lt;User, <span class="hljs-built_in">string</span>&gt;.Success)result).ResultValue;
  <span class="hljs-keyword">var</span> result2 = GetEmailAddress(user);
  <span class="hljs-keyword">if</span> (result2 <span class="hljs-keyword">is</span> Result&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;.Success) {
    <span class="hljs-keyword">var</span> email = ((Result&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;.Success)result2).ResultValue;
    <span class="hljs-comment">// And so on...</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">var</span> error2 = ((Result&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;.Failure)result2).ErrorValue;
    <span class="hljs-comment">// Handle the failure appropriately</span>
  }
} <span class="hljs-keyword">else</span> {
  <span class="hljs-keyword">var</span> error = ((Result&lt;User, <span class="hljs-built_in">string</span>&gt;.Failure)result).ErrorValue;
  <span class="hljs-comment">// Handle the failure appropriately</span>
}</code></pre> </div> </div> <div class="paragraph"> <p>We would like to</p> </div> <div class="ulist"> <ul> <li> <p>not have to unwrap the result type by doing a type check + cast</p> </li> <li> <p>not have a new nesting level for each subsequent function we call</p> </li> <li> <p>not have to handle all failures individually</p> </li> <li> <p>not have to specify the whole type when creating a Result instance: <code>new Result&lt;User, string&gt;.Success()</code></p> </li> </ul> </div> <div class="sect2"> <h3 id="_a_fluent_result_type">A Fluent Result type</h3> <div class="paragraph"> <p>To resolve the complaints about our previous implementation, we&#8217;ll define an <code>OnSuccess</code> function and a <code>Handle</code> function. They will do the unwrapping for us and form a <a href="https://en.wikipedia.org/wiki/Fluent_interface">Fluent Interface</a> and thereby removing the nesting. Moreover, the OnSuccess function will "shortcircuit" the failure path, such that we only have to handle the failure path once.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-cs" data-lang="cs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Result</span>&lt;<span class="hljs-title">TS</span>, <span class="hljs-title">TF</span>&gt; {
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-title">Result</span>&lt;<span class="hljs-title">TNextR</span>, <span class="hljs-title">TF</span>&gt; <span class="hljs-title">OnSuccess</span>&lt;<span class="hljs-title">TNextR</span>&gt;(<span class="hljs-params">Func&lt;TS, Result&lt;TNextR, TF&gt;&gt; onSuccess</span>)</span>;
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> TReturn <span class="hljs-title">Handle</span>&lt;<span class="hljs-title">TReturn</span>&gt;(<span class="hljs-params">Func&lt;TS, TReturn&gt; onSuccess, Func&lt;TF, TReturn&gt; onFailure</span>)</span>;

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Success</span> : <span class="hljs-title">Result</span>&lt;<span class="hljs-title">TS</span>, <span class="hljs-title">TF</span>&gt; {
    <span class="hljs-keyword">public</span> TS SuccessValue { <span class="hljs-keyword">get</span>; }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Success</span>(<span class="hljs-params">TS result</span>)</span> =&gt; SuccessValue = result;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-title">Result</span>&lt;<span class="hljs-title">TNextR</span>, <span class="hljs-title">TF</span>&gt; <span class="hljs-title">OnSuccess</span>&lt;<span class="hljs-title">TNextR</span>&gt;(<span class="hljs-params">Func&lt;TS, Result&lt;TNextR, TF&gt;&gt; onSuccess</span>)</span>
        =&gt; onSuccess(SuccessValue);
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> TReturn <span class="hljs-title">Handle</span>&lt;<span class="hljs-title">TReturn</span>&gt;(<span class="hljs-params">Func&lt;TS, TReturn&gt; onSuccess, Func&lt;TF, TReturn&gt; onFailure</span>)</span>
        =&gt; onSuccess(SuccessValue);
  }

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Failure</span> : <span class="hljs-title">Result</span>&lt;<span class="hljs-title">TS</span>, <span class="hljs-title">TF</span>&gt; {
    <span class="hljs-keyword">public</span> TF FailureValue { <span class="hljs-keyword">get</span>; }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Failure</span>(<span class="hljs-params">TF error</span>)</span> =&gt; FailureValue = error;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-title">Result</span>&lt;<span class="hljs-title">TNextR</span>, <span class="hljs-title">TF</span>&gt; <span class="hljs-title">OnSuccess</span>&lt;<span class="hljs-title">TNextR</span>&gt;(<span class="hljs-params">Func&lt;TS, Result&lt;TNextR, TF&gt;&gt; onSuccess</span>)</span>
        =&gt; Result.Fail(FailureValue);
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> TReturn <span class="hljs-title">Handle</span>&lt;<span class="hljs-title">TReturn</span>&gt;(<span class="hljs-params">Func&lt;TS, TReturn&gt; onSuccess, Func&lt;TF, TReturn&gt; onFailure</span>)</span>
        =&gt; onFailure(FailureValue);
  }
  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Result</span>(<span class="hljs-params"></span>)</span> { }
}</code></pre> </div> </div> <div class="paragraph"> <p>Apart from the daunting function signatures, the actual function bodies are trivial. Yet they suddenly allow us to write very concise code. Compare the following with what we had in the previous section.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-cs" data-lang="cs">GetUser(username)
  .OnSuccess(GetEmailAddress);
  .Handle(
    emailAddress =&gt; ..., <span class="hljs-comment">// Do your thing</span>
    error =&gt; ... <span class="hljs-comment">// Handle the failure appropriately</span>
  );</code></pre> </div> </div> <div class="paragraph"> <p>If we visualize the code flow above in a diagram, it becomes clear why this style of programming is sometimes referred to as <a href="https://fsharpforfunandprofit.com/rop/"><em>railway oriented programming</em></a>. The Result type encapsulates two "paths" or "tracks", the success track and the failure track.</p> </div> <div class="imageblock kroki"> <div class="content"> <svg xmlns="http://www.w3.org/2000/svg" class="pikchr" width="149" height="51" viewbox="0 0 187.43 64.8"> <polygon points="106,17 95,21 95,12" style="fill:#add8e6"></polygon> <path d="M34,17L100,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <polygon points="106,47 95,51 95,43" style="fill:orange"></polygon> <path d="M34,47L100,47" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M17,47L52,47A15 15 0 0 0 67 32A15 15 0 0 0 52 17L17,17A15 15 0 0 0 2 32A15 15 0 0 0 17 47Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="34" y="32" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">Result</text> <path d="M121,32L170,32A15 15 0 0 0 185 17A15 15 0 0 0 170 2L121,2A15 15 0 0 0 106 17A15 15 0 0 0 121 32Z" style="fill:#add8e6;stroke-width:2.16;stroke:#000"></path> <text x="145" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">Success</text> <path d="M121,62L163,62A15 15 0 0 0 178 47A15 15 0 0 0 163 32L121,32A15 15 0 0 0 106 47A15 15 0 0 0 121 62Z" style="fill:orange;stroke-width:2.16;stroke:#000"></path> <text x="142" y="47" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">Failure</text> </svg> </div> </div> <div class="paragraph"> <p>And the <code>OnSuccess</code> and <code>Handle</code> methods form trackpieces.</p> </div> <div class="imageblock kroki"> <div class="content"> <svg xmlns="http://www.w3.org/2000/svg" class="pikchr" width="508" height="44" viewbox="0 0 636.653 55.44"> <path d="M133,17 L 140,17 Q 147,17 147,31 L 147,34 Q 147,48 156,48 L 165,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M133,17L165,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M291,17L307,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <polygon points="30,17 19,21 19,12" style="fill:#add8e6"></polygon> <path d="M2,17L25,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M30,32L133,32L133,2L30,2Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="82" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">OnSuccess</text> <path d="M180,32L276,32A15 15 0 0 0 291 17A15 15 0 0 0 276 2L180,2A15 15 0 0 0 165 17A15 15 0 0 0 180 32Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="228" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">SuccessValue</text> <path d="M2,48L307,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <polygon points="407,17 396,21 396,12" style="fill:#add8e6"></polygon> <path d="M379,17L402,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <polygon points="407,48 396,53 396,44" style="fill:orange"></polygon> <path d="M379,48L402,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M407,48L480,48L480,17L407,17Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="444" y="33" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">Handle</text> <path d="M480,33L508,33" style="fill:none;stroke-width:2.16;stroke:#000"></path> <path d="M524,48L586,48A15 15 0 0 0 601 33L601,33A15 15 0 0 0 586 18L524,18A15 15 0 0 0 508 33L508,33A15 15 0 0 0 524 48Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="555" y="33" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">EndValue</text> <polygon points="630,33 618,37 618,28" style="fill:#000"></polygon> <path d="M601,33L624,33" style="fill:none;stroke-width:2.16;stroke:#000"></path> </svg> </div> </div> <div class="paragraph"> <p>The railway of the example code would look like</p> </div> <div class="imageblock kroki"> <div class="content"> <svg xmlns="http://www.w3.org/2000/svg" class="pikchr" width="582" height="52" viewbox="0 0 728.064 66.24"> <path d="M111,17 L 118,17 Q 125,17 125,31 L 125,34 Q 125,48 134,48 L 142,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M204,48L219,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M111,17L139,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M191,17L207,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M392,17 L 399,17 Q 406,17 406,31 L 406,34 Q 406,48 415,48 L 424,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M392,17L424,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M485,17L501,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <polygon points="30,17 19,21 19,12" style="fill:#000"></polygon> <path d="M2,17L25,17" style="fill:none;stroke-width:2.16;stroke:#000"></path> <path d="M30,32L111,32L111,2L30,2Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="70" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">GetUser</text> <path d="M157,64L188,64A15 15 0 0 0 204 48L204,48A15 15 0 0 0 188 33L157,33A15 15 0 0 0 142 48L142,48A15 15 0 0 0 157 64Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="173" y="48" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">string</text> <path d="M154,32L176,32A15 15 0 0 0 191 17A15 15 0 0 0 176 2L154,2A15 15 0 0 0 139 17A15 15 0 0 0 154 32Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="165" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">User</text> <polygon points="235,17 224,21 224,12" style="fill:#add8e6"></polygon> <path d="M207,17L230,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M235,32L392,32L392,2L235,2Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="314" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">GetEmailAddress</text> <path d="M439,32L470,32A15 15 0 0 0 485 17A15 15 0 0 0 470 2L439,2A15 15 0 0 0 424 17A15 15 0 0 0 439 32Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="454" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">string</text> <path d="M207,48L501,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <polygon points="530,17 518,21 518,12" style="fill:#add8e6"></polygon> <path d="M501,17L524,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <polygon points="530,48 518,53 518,44" style="fill:orange"></polygon> <path d="M501,48L524,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M530,48L602,48L602,17L530,17Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="566" y="33" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">Handle</text> <path d="M602,33L631,33" style="fill:none;stroke-width:2.16;stroke:#000"></path> <path d="M646,48L677,48A15 15 0 0 0 692 33L692,33A15 15 0 0 0 677 18L646,18A15 15 0 0 0 631 33L631,33A15 15 0 0 0 646 48Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="662" y="33" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">string</text> <polygon points="721,33 710,37 710,28" style="fill:#000"></polygon> <path d="M692,33L715,33" style="fill:none;stroke-width:2.16;stroke:#000"></path> </svg> </div> </div> </div> <div class="sect2"> <h3 id="_another_example">Another Example</h3> <div class="paragraph"> <p>Suppose now that we needed to write the following function.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-cs" data-lang="cs"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>Message to be printed on the screen<span class="hljs-doctag">&lt;/returns&gt;</span></span>
<span class="hljs-function"><span class="hljs-built_in">string</span> <span class="hljs-title">MailMessageToUser</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> username, <span class="hljs-built_in">string</span> msg</span>)</span>;</code></pre> </div> </div> <div class="paragraph"> <p>And suppose that we have the following functions at our disposal.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-cs" data-lang="cs"><span class="hljs-function">Result&lt;User, <span class="hljs-built_in">string</span>&gt; <span class="hljs-title">GetUser</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> username</span>)</span>;
<span class="hljs-function">Result&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; <span class="hljs-title">GetEmailAddress</span>(<span class="hljs-params">User user</span>)</span>;
<span class="hljs-function">Result&lt;EmailMessage, <span class="hljs-built_in">string</span>&gt; <span class="hljs-title">CreateEmailMessage</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> emailAddress, <span class="hljs-built_in">string</span> msg</span>)</span>;
<span class="hljs-function">Result&lt;Unit, <span class="hljs-built_in">string</span>&gt; <span class="hljs-title">SendEmail</span>(<span class="hljs-params">EmailMessage email</span>)</span>;</code></pre> </div> </div> <div class="paragraph"> <p>If you&#8217;re wondering what that <code>Unit</code> type is, it&#8217;s a replacement for <code>void</code>, since we can&#8217;t put <code>void</code> in there. For more information <a href="/?page=unit-cs">read my respective article</a>.</p> </div> <div class="paragraph"> <p>Then we could implement the function as follows.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-cs" data-lang="cs"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>Message to be printed on the screen<span class="hljs-doctag">&lt;/returns&gt;</span></span>
<span class="hljs-function"><span class="hljs-built_in">string</span> <span class="hljs-title">MailMessageToUser</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> username, <span class="hljs-built_in">string</span> msg</span>)</span> {
  <span class="hljs-keyword">return</span> GetUser(username)
    .OnSuccess(GetEmailAddress)
    .OnSuccess(email =&gt; CreateEmailMessage(email, msg))
    .OnSuccess(SendEmail)
    .Handle(
      _ =&gt; <span class="hljs-string">&quot;Email sent&quot;</span>,
      error =&gt; {
        Log(error);
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Email not sent&quot;</span>;
      }
    );
}</code></pre> </div> </div> <div class="paragraph"> <p>The railway of the example code would look like</p> </div> <div class="imageblock kroki"> <div class="content"> <svg xmlns="http://www.w3.org/2000/svg" class="pikchr" width="742" height="114" viewbox="0 0 928.166 143.28"> <path d="M293,105 L 301,105 Q 308,105 308,119 L 308,122 Q 308,136 316,136 L 325,136" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M293,105L325,105" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M459,105L475,105" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M606,105 L 613,105 Q 620,105 620,119 L 620,122 Q 620,136 629,136 L 637,136" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M606,105L637,105" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M685,105L701,105" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M111,17 L 118,17 Q 125,17 125,31 L 125,34 Q 125,48 134,48 L 142,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M204,48L219,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M111,17L139,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M191,17L207,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M392,17 L 399,17 Q 406,17 406,31 L 406,34 Q 406,48 415,48 L 424,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M392,17L424,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M485,17L501,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <polygon points="30,17 19,21 19,12" style="fill:#000"></polygon> <path d="M2,17L25,17" style="fill:none;stroke-width:2.16;stroke:#000"></path> <path d="M30,32L111,32L111,2L30,2Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="70" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">GetUser</text> <path d="M157,64L188,64A15 15 0 0 0 204 48L204,48A15 15 0 0 0 188 33L157,33A15 15 0 0 0 142 48L142,48A15 15 0 0 0 157 64Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="173" y="48" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">string</text> <path d="M154,32L176,32A15 15 0 0 0 191 17A15 15 0 0 0 176 2L154,2A15 15 0 0 0 139 17A15 15 0 0 0 154 32Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="165" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">User</text> <polygon points="235,17 224,21 224,12" style="fill:#add8e6"></polygon> <path d="M207,17L230,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M235,32L392,32L392,2L235,2Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="314" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">GetEmailAddress</text> <path d="M439,32L470,32A15 15 0 0 0 485 17A15 15 0 0 0 470 2L439,2A15 15 0 0 0 424 17A15 15 0 0 0 439 32Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="454" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">string</text> <path d="M207,48L501,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <polygon points="102,105 91,109 91,100" style="fill:#add8e6"></polygon> <path d="M74,105L97,105" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M102,120L293,120L293,90L102,90Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="198" y="105" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">CreateEmailMessage</text> <path d="M340,120L444,120A15 15 0 0 0 459 105A15 15 0 0 0 444 90L340,90A15 15 0 0 0 325 105A15 15 0 0 0 340 120Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="392" y="105" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">EmailMessage</text> <path d="M74,136L475,136" style="fill:none;stroke-width:2.16;stroke:orange"></path> <polygon points="504,105 492,109 492,100" style="fill:#add8e6"></polygon> <path d="M475,105L498,105" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M504,120L606,120L606,90L504,90Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="555" y="105" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">SendEmail</text> <path d="M653,120L670,120A15 15 0 0 0 685 105A15 15 0 0 0 670 90L653,90A15 15 0 0 0 637 105A15 15 0 0 0 653 120Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="661" y="105" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">Unit</text> <path d="M475,136L701,136" style="fill:none;stroke-width:2.16;stroke:orange"></path> <polygon points="730,105 718,109 718,100" style="fill:#add8e6"></polygon> <path d="M701,105L724,105" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <polygon points="730,136 718,141 718,132" style="fill:orange"></polygon> <path d="M701,136L724,136" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M730,136L802,136L802,105L730,105Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="766" y="120" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">Handle</text> <path d="M802,120L831,120" style="fill:none;stroke-width:2.16;stroke:#000"></path> <path d="M846,136L877,136A15 15 0 0 0 892 120A15 15 0 0 0 877 105L846,105A15 15 0 0 0 831 120A15 15 0 0 0 846 136Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="862" y="120" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">string</text> <polygon points="921,120 910,125 910,116" style="fill:#000"></polygon> <path d="M892,120L915,120" style="fill:none;stroke-width:2.16;stroke:#000"></path> </svg> </div> </div> </div> <div class="sect2"> <h3 id="_the_onfailure_method">The OnFailure method</h3> <div class="paragraph"> <p>If we have a OnSuccess method, there is no reason why we couldn&#8217;t have an OnFailure method too. This would allow us to do operations on the failure track, such as modifying or logging the error, or recovering from the error and get back on the success track.</p> </div> <div class="imageblock kroki"> <div class="content"> <svg xmlns="http://www.w3.org/2000/svg" class="pikchr" width="137" height="40" viewbox="0 0 172.166 51.12"> <path d="M126,33 L 134,33 Q 141,33 141,19 L 141,16 Q 141,2 155,2 L 155,2 L 170,2" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M126,33L170,33" style="fill:none;stroke-width:2.16;stroke:orange"></path> <polygon points="30,33 19,38 19,29" style="fill:orange"></polygon> <path d="M2,33L25,33" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M30,48L126,48L126,18L30,18Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="78" y="33" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">OnFailure</text> <path d="M2,2L170,2" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> </svg> </div> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-cs" data-lang="cs"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>Message to be printed on the screen<span class="hljs-doctag">&lt;/returns&gt;</span></span>
<span class="hljs-function"><span class="hljs-built_in">string</span> <span class="hljs-title">MailMessageToUser</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> username, <span class="hljs-built_in">string</span> msg</span>)</span> {
  <span class="hljs-keyword">return</span> GetUser(username)
    .OnSuccess(GetEmailAddress)
    .OnSuccess(email =&gt; CreateEmailMessage(email, msg))
    .OnSuccess(SendEmail)
    .OnFailure&lt;<span class="hljs-built_in">string</span>&gt;(error =&gt; {
      LogError(error);
      <span class="hljs-keyword">return</span> Result.Fail(error); <span class="hljs-comment">// Only log the error and leave the Failure be</span>
    })
    .Handle(
      _ =&gt; <span class="hljs-string">&quot;Email sent&quot;</span>,
      _ =&gt; <span class="hljs-string">&quot;Email not sent&quot;</span>
    );
}</code></pre> </div> </div> <div class="imageblock kroki"> <div class="content"> <svg xmlns="http://www.w3.org/2000/svg" class="pikchr" width="723" height="123" viewbox="0 0 904.896 154.08"> <path d="M204,105 L 212,105 Q 219,105 219,119 L 219,122 Q 219,136 227,136 L 236,136" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M204,105L236,105" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M284,105L300,105" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M432,136L461,136" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M111,17 L 118,17 Q 125,17 125,31 L 125,34 Q 125,48 134,48 L 142,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M204,48L219,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M111,17L139,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M191,17L207,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M392,17 L 399,17 Q 406,17 406,31 L 406,34 Q 406,48 415,48 L 424,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M392,17L424,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M485,17L501,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M721,17 L 728,17 Q 735,17 735,31 L 735,34 Q 735,48 744,48 L 752,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M721,17L752,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M886,17L902,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <polygon points="30,17 19,21 19,12" style="fill:#000"></polygon> <path d="M2,17L25,17" style="fill:none;stroke-width:2.16;stroke:#000"></path> <path d="M30,32L111,32L111,2L30,2Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="70" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">GetUser</text> <path d="M157,64L188,64A15 15 0 0 0 204 48L204,48A15 15 0 0 0 188 33L157,33A15 15 0 0 0 142 48L142,48A15 15 0 0 0 157 64Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="173" y="48" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">string</text> <path d="M154,32L176,32A15 15 0 0 0 191 17A15 15 0 0 0 176 2L154,2A15 15 0 0 0 139 17A15 15 0 0 0 154 32Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="165" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">User</text> <polygon points="235,17 224,21 224,12" style="fill:#add8e6"></polygon> <path d="M207,17L230,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M235,32L392,32L392,2L235,2Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="314" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">GetEmailAddress</text> <path d="M439,32L470,32A15 15 0 0 0 485 17A15 15 0 0 0 470 2L439,2A15 15 0 0 0 424 17A15 15 0 0 0 439 32Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="454" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">string</text> <path d="M207,48L501,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <polygon points="530,17 518,21 518,12" style="fill:#add8e6"></polygon> <path d="M501,17L524,17" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M530,32L721,32L721,2L530,2Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="625" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">CreateEmailMessage</text> <path d="M767,32L871,32A15 15 0 0 0 886 17A15 15 0 0 0 871 2L767,2A15 15 0 0 0 752 17A15 15 0 0 0 767 32Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="819" y="17" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">EmailMessage</text> <path d="M501,48L902,48" style="fill:none;stroke-width:2.16;stroke:orange"></path> <polygon points="102,105 91,109 91,100" style="fill:#add8e6"></polygon> <path d="M74,105L97,105" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <path d="M102,120L204,120L204,90L102,90Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="153" y="105" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">SendEmail</text> <path d="M251,120L269,120A15 15 0 0 0 284 105A15 15 0 0 0 269 90L251,90A15 15 0 0 0 236 105A15 15 0 0 0 251 120Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="260" y="105" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">Unit</text> <path d="M74,136L300,136" style="fill:none;stroke-width:2.16;stroke:orange"></path> <polygon points="329,136 317,141 317,132" style="fill:orange"></polygon> <path d="M300,136L323,136" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M329,151L432,151L432,121L329,121Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="380" y="136" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">LogFailure</text> <path d="M300,105L461,105" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <polygon points="490,105 478,109 478,100" style="fill:#add8e6"></polygon> <path d="M461,105L484,105" style="fill:none;stroke-width:2.16;stroke:#add8e6"></path> <polygon points="490,136 478,141 478,132" style="fill:orange"></polygon> <path d="M461,136L484,136" style="fill:none;stroke-width:2.16;stroke:orange"></path> <path d="M490,136L562,136L562,105L490,105Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="526" y="120" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">Handle</text> <path d="M562,120L591,120" style="fill:none;stroke-width:2.16;stroke:#000"></path> <path d="M606,136L637,136A15 15 0 0 0 652 120A15 15 0 0 0 637 105L606,105A15 15 0 0 0 591 120A15 15 0 0 0 606 136Z" style="fill:none;stroke-width:2.16;stroke:#000"></path> <text x="621" y="120" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">string</text> <polygon points="681,120 669,125 669,116" style="fill:#000"></polygon> <path d="M652,120L675,120" style="fill:none;stroke-width:2.16;stroke:#000"></path> </svg> </div> </div> <div class="paragraph"> <p>We still need to deal with the awkward construction of Result instances, and we&#8217;ll do that in the next part.</p> </div> </div> </div> </div> </div> <div id="footer"> <div id="footer-text"> Last updated 2021-08-02 19:14:08 +0200 </div> </div> </body></html>